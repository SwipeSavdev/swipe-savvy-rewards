# Nginx Configuration for SwipeSavvy API Gateway\n\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log warn;\npid /var/run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n    use epoll;\n}\n\nhttp {\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    log_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                    '$status $body_bytes_sent \"$http_referer\" '\n                    '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log /var/log/nginx/access.log main;\n\n    # Performance optimizations\n    sendfile on;\n    tcp_nopush on;\n    tcp_nodelay on;\n    keepalive_timeout 65;\n    types_hash_max_size 2048;\n    client_max_body_size 20M;\n\n    # Gzip compression\n    gzip on;\n    gzip_vary on;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_types text/plain text/css text/xml text/javascript \n               application/json application/javascript application/xml+rss \n               application/rss+xml font/truetype font/opentype \n               application/vnd.ms-fontobject image/svg+xml;\n\n    # Rate limiting\n    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;\n    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;\n\n    # Upstream services\n    upstream ai_agent {\n        least_conn;\n        server ai-agent:8000 max_fails=3 fail_timeout=30s;\n        keepalive 32;\n    }\n\n    upstream mobile_wallet {\n        least_conn;\n        server mobile-wallet:8001 max_fails=3 fail_timeout=30s;\n        keepalive 32;\n    }\n\n    upstream admin_portal {\n        server admin-portal:3000 max_fails=3 fail_timeout=30s;\n    }\n\n    upstream mobile_app {\n        server mobile-app:8081 max_fails=3 fail_timeout=30s;\n    }\n\n    upstream customer_website {\n        server customer-website:8080 max_fails=3 fail_timeout=30s;\n    }\n\n    # HTTP redirect to HTTPS (optional, remove for dev)\n    # server {\n    #     listen 80;\n    #     server_name _;\n    #     return 301 https://$host$request_uri;\n    # }\n\n    # Main server block\n    server {\n        listen 80;\n        server_name _;\n\n        # Security headers\n        add_header X-Frame-Options \"SAMEORIGIN\" always;\n        add_header X-Content-Type-Options \"nosniff\" always;\n        add_header X-XSS-Protection \"1; mode=block\" always;\n        add_header Referrer-Policy \"no-referrer-when-downgrade\" always;\n        add_header Content-Security-Policy \"default-src 'self' http: https: data: blob: 'unsafe-inline'\" always;\n\n        # Health check endpoint\n        location /health {\n            access_log off;\n            return 200 \"healthy\\n\";\n            add_header Content-Type text/plain;\n        }\n\n        # API Gateway - AI Agent routes\n        location /api/ai/ {\n            limit_req zone=api_limit burst=20;\n            \n            proxy_pass http://ai_agent;\n            proxy_http_version 1.1;\n            proxy_set_header Connection \"\";\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Timeouts\n            proxy_connect_timeout 60s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n            \n            # Buffering\n            proxy_buffering on;\n            proxy_buffer_size 4k;\n            proxy_buffers 8 4k;\n        }\n\n        # API Gateway - Wallet routes\n        location /api/wallet/ {\n            limit_req zone=api_limit burst=20;\n            \n            proxy_pass http://mobile_wallet;\n            proxy_http_version 1.1;\n            proxy_set_header Connection \"\";\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            proxy_connect_timeout 60s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n            \n            proxy_buffering on;\n            proxy_buffer_size 4k;\n            proxy_buffers 8 4k;\n        }\n\n        # API Gateway - Auth routes\n        location /api/auth/ {\n            limit_req zone=general_limit burst=5;\n            \n            proxy_pass http://ai_agent;\n            proxy_http_version 1.1;\n            proxy_set_header Connection \"\";\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            proxy_connect_timeout 30s;\n            proxy_send_timeout 30s;\n            proxy_read_timeout 30s;\n        }\n\n        # Admin Portal\n        location /admin/ {\n            proxy_pass http://admin_portal/;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection \"upgrade\";\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n        }\n\n        # Customer Website\n        location / {\n            proxy_pass http://customer_website;\n            proxy_http_version 1.1;\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Cache static assets\n            proxy_cache_valid 200 10d;\n            expires 10d;\n        }\n\n        # WebSocket support for real-time features\n        location /ws/ {\n            proxy_pass http://ai_agent;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection \"upgrade\";\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # WebSocket specific timeouts\n            proxy_read_timeout 3600s;\n            proxy_send_timeout 3600s;\n            \n            # Disable buffering for WebSocket\n            proxy_buffering off;\n        }\n\n        # 404 handler\n        error_page 404 /404.html;\n        location = /404.html {\n            internal;\n            default_type application/json;\n            return 404 '{\"error\":\"Not found\"}';\n        }\n\n        # 500 handler\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n            internal;\n            default_type application/json;\n            return 500 '{\"error\":\"Server error\"}';\n        }\n    }\n}\n