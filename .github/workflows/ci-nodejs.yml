name: CI - Node.js Projects

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'swipesavvy-admin-portal/**'
      - 'swipesavvy-wallet-web/**'
      - 'swipesavvy-mobile-app/**'
      - '.github/workflows/ci-nodejs.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'swipesavvy-admin-portal/**'
      - 'swipesavvy-wallet-web/**'
      - 'swipesavvy-mobile-app/**'

jobs:
  version-check:
    runs-on: ubuntu-latest
    name: Version Checks
    strategy:
      matrix:
        node-version: ['20.13.0']
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Verify Node.js version
        run: |
          EXPECTED_NODE="20.13.0"
          ACTUAL_NODE=$(node --version | sed 's/v//')
          if [[ "$ACTUAL_NODE" != "$EXPECTED_NODE" ]]; then
            echo "‚ùå Node version mismatch. Expected $EXPECTED_NODE, got $ACTUAL_NODE"
            exit 1
          fi
          echo "‚úÖ Node.js version verified: $ACTUAL_NODE"
      
      - name: Verify npm version
        run: |
          EXPECTED_NPM="10.8.2"
          ACTUAL_NPM=$(npm --version)
          echo "npm version: $ACTUAL_NPM (expected: $EXPECTED_NPM or higher)"
      
      - name: Check .nvmrc files
        run: |
          for repo in swipesavvy-admin-portal swipesavvy-wallet-web swipesavvy-mobile-app swipesavvy-mobile-wallet-native; do
            if [ -f "$repo/.nvmrc" ]; then
              echo "‚úÖ Found .nvmrc in $repo: $(cat $repo/.nvmrc)"
            else
              echo "‚ùå Missing .nvmrc in $repo"
              exit 1
            fi
          done

  lock-file-validation:
    runs-on: ubuntu-latest
    name: Lock File Validation
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify package-lock.json files
        run: |
          for repo in swipesavvy-admin-portal swipesavvy-wallet-web swipesavvy-mobile-app swipesavvy-mobile-wallet-native; do
            if [ -f "$repo/package-lock.json" ]; then
              echo "‚úÖ Found package-lock.json in $repo"
              # Verify lock file integrity
              cd "$repo"
              npm ls --depth=0 > /dev/null 2>&1 || {
                echo "‚ùå package-lock.json is corrupted in $repo"
                exit 1
              }
              cd ..
            else
              echo "‚ùå Missing package-lock.json in $repo"
              exit 1
            fi
          done
          echo "‚úÖ All lock files validated"

  lint-admin-portal:
    runs-on: ubuntu-latest
    name: Lint & Test - Admin Portal
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.13.0'
          cache: 'npm'
          cache-dependency-path: 'swipesavvy-admin-portal/package-lock.json'
      
      - name: Install dependencies
        working-directory: swipesavvy-admin-portal
        run: npm ci
      
      - name: Run ESLint
        working-directory: swipesavvy-admin-portal
        run: npx eslint src/ --ext .ts,.tsx --format json > eslint-report.json || true
        continue-on-error: true
      
      - name: Check ESLint for critical errors
        working-directory: swipesavvy-admin-portal
        run: |
          if grep -q '"severity":"error"' eslint-report.json; then
            echo "‚ö†Ô∏è  ESLint errors found (non-blocking for now)"
          fi
      
      - name: Run type check
        working-directory: swipesavvy-admin-portal
        run: npx tsc --noEmit --pretty
      
      - name: Build project
        working-directory: swipesavvy-admin-portal
        run: npm run build
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: admin-portal-build
          path: swipesavvy-admin-portal/dist/
          retention-days: 5

  lint-wallet-web:
    runs-on: ubuntu-latest
    name: Lint & Test - Wallet Web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.13.0'
          cache: 'npm'
          cache-dependency-path: 'swipesavvy-wallet-web/package-lock.json'
      
      - name: Install dependencies
        working-directory: swipesavvy-wallet-web
        run: npm ci
      
      - name: Run ESLint
        working-directory: swipesavvy-wallet-web
        run: npx eslint src/ --ext .ts,.tsx --format json > eslint-report.json || true
        continue-on-error: true
      
      - name: Run type check
        working-directory: swipesavvy-wallet-web
        run: npx tsc --noEmit --pretty
      
      - name: Build project
        working-directory: swipesavvy-wallet-web
        run: npm run build
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: wallet-web-build
          path: swipesavvy-wallet-web/dist/
          retention-days: 5

  lint-mobile-app:
    runs-on: ubuntu-latest
    name: Lint & Test - Mobile App
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.13.0'
          cache: 'npm'
          cache-dependency-path: 'swipesavvy-mobile-app/package-lock.json'
      
      - name: Install dependencies
        working-directory: swipesavvy-mobile-app
        run: npm ci
      
      - name: Run ESLint
        working-directory: swipesavvy-mobile-app
        run: npx eslint src/ --ext .ts,.tsx,js,jsx --format json > eslint-report.json || true
        continue-on-error: true
      
      - name: Run type check
        working-directory: swipesavvy-mobile-app
        run: npx tsc --noEmit --pretty
      
      - name: Run tests
        working-directory: swipesavvy-mobile-app
        run: npm test -- --passWithNoTests --coverage
        continue-on-error: true
      
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: mobile-app-coverage
          path: swipesavvy-mobile-app/coverage/
          retention-days: 5

  security-audit:
    runs-on: ubuntu-latest
    name: Security Audit
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.13.0'
      
      - name: Run npm audit on all repos
        run: |
          echo "üîç Running npm audit on all Node.js projects..."
          for repo in swipesavvy-admin-portal swipesavvy-wallet-web swipesavvy-mobile-app swipesavvy-mobile-wallet-native; do
            echo ""
            echo "Auditing $repo..."
            cd "$repo"
            npm audit --json > audit-report.json 2>&1 || true
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå CRITICAL vulnerabilities found in $repo: $CRITICAL"
              exit 1
            else
              echo "‚úÖ No critical vulnerabilities in $repo"
            fi
            cd ..
          done

  summary:
    runs-on: ubuntu-latest
    name: CI Summary
    needs: [version-check, lock-file-validation, lint-admin-portal, lint-wallet-web, lint-mobile-app, security-audit]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          if [[ "${{ needs.version-check.result }}" == "failure" ]] || \
             [[ "${{ needs.lock-file-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-admin-portal.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-wallet-web.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-mobile-app.result }}" == "failure" ]] || \
             [[ "${{ needs.security-audit.result }}" == "failure" ]]; then
            echo "‚ùå CI pipeline failed"
            exit 1
          else
            echo "‚úÖ All CI checks passed"
          fi
