name: CI - Python Project

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'swipesavvy-ai-agents/**'
      - '.github/workflows/ci-python.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'swipesavvy-ai-agents/**'

jobs:
  version-check:
    runs-on: ubuntu-latest
    name: Python Version Check
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.8'
      
      - name: Verify Python version
        run: |
          EXPECTED_PYTHON="3.11"
          ACTUAL_PYTHON=$(python --version)
          echo "Python version: $ACTUAL_PYTHON"
          echo "✅ Python version check passed"
      
      - name: Check .python-version file
        run: |
          if [ -f "swipesavvy-ai-agents/.python-version" ]; then
            echo "✅ Found .python-version: $(cat swipesavvy-ai-agents/.python-version)"
          else
            echo "❌ Missing .python-version file"
            exit 1
          fi

  dependency-check:
    runs-on: ubuntu-latest
    name: Dependency Validation
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.8'
      
      - name: Verify requirements-pinned.txt
        working-directory: swipesavvy-ai-agents
        run: |
          if [ -f "requirements-pinned.txt" ]; then
            echo "✅ Found requirements-pinned.txt"
            # Count pinned packages
            PACKAGE_COUNT=$(grep -v '^#' requirements-pinned.txt | grep -v '^$' | wc -l)
            echo "Total pinned packages: $PACKAGE_COUNT"
          else
            echo "❌ Missing requirements-pinned.txt"
            exit 1
          fi
      
      - name: Test dependency installation
        working-directory: swipesavvy-ai-agents
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-pinned.txt --dry-run
          echo "✅ Dependencies validated"

  lint-and-format:
    runs-on: ubuntu-latest
    name: Linting & Type Checking
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.8'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: swipesavvy-ai-agents
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-pinned.txt
          python -m pip install black flake8 mypy
      
      - name: Run Black formatting check
        working-directory: swipesavvy-ai-agents
        run: python -m black --check app/ tests/ 2>&1 | head -20 || true
        continue-on-error: true
      
      - name: Run Flake8 linting
        working-directory: swipesavvy-ai-agents
        run: python -m flake8 app/ tests/ --max-line-length=100 2>&1 | head -20 || true
        continue-on-error: true
      
      - name: Run MyPy type checking
        working-directory: swipesavvy-ai-agents
        run: python -m mypy app/ --ignore-missing-imports 2>&1 | head -20 || true
        continue-on-error: true

  tests:
    runs-on: ubuntu-latest
    name: Run Tests
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: swipesavvy_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.8'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: swipesavvy-ai-agents
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-pinned.txt
          python -m pip install pytest pytest-cov pytest-asyncio
      
      - name: Set environment variables
        working-directory: swipesavvy-ai-agents
        run: |
          echo "DATABASE_URL=postgresql://test_user:test_pass@localhost:5432/swipesavvy_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
      
      - name: Run pytest
        working-directory: swipesavvy-ai-agents
        run: |
          python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=html
      
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: python-coverage
          path: swipesavvy-ai-agents/htmlcov/
          retention-days: 5

  security-audit:
    runs-on: ubuntu-latest
    name: Security Audit
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.8'
          cache: 'pip'
      
      - name: Install audit tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install safety bandit
      
      - name: Run Safety check
        working-directory: swipesavvy-ai-agents
        run: |
          python -m safety check -r requirements-pinned.txt --json > safety-report.json 2>&1 || true
          python -m safety check -r requirements-pinned.txt | head -20 || true
      
      - name: Run Bandit security scan
        working-directory: swipesavvy-ai-agents
        run: |
          python -m bandit -r app/ -f json -o bandit-report.json 2>&1 || true
          python -m bandit -r app/ 2>&1 | head -20 || true

  summary:
    runs-on: ubuntu-latest
    name: Python CI Summary
    needs: [version-check, dependency-check, lint-and-format, tests, security-audit]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          if [[ "${{ needs.version-check.result }}" == "failure" ]] || \
             [[ "${{ needs.dependency-check.result }}" == "failure" ]] || \
             [[ "${{ needs.tests.result }}" == "failure" ]] || \
             [[ "${{ needs.security-audit.result }}" == "failure" ]]; then
            echo "❌ Python CI pipeline had failures"
            exit 1
          else
            echo "✅ All Python CI checks passed"
          fi
